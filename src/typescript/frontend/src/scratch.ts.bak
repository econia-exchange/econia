import { useQuery } from "@tanstack/react-query";
import { ECONIA_ADDR } from "./env";
import { MoveEventHandle, MoveTableHandle } from "./types/move";
import { AccountKeys } from "@manahippo/aptos-wallet-adapter";
import { useAptos } from "./contexts/AptosContext";
import { U64 } from "aptos/src/generated";
import { TypeTag } from "./utils/TypeTag";
import { TabList } from "./types/econia";

type Registry = {
  market_id_to_info: TabList<U64>;
  market_info_to_id: MoveTableHandle;
  market_registration_events: MoveEventHandle;
  n_custodians: U64;
  n_underwriters: U64;
};

export const useRegistry = (marketId: string) => {
  const { aptosClient } = useAptos();
  const { data: registry } = useQuery(["useRegistry", marketId], async () => {
    try {
      const resource = await aptosClient.getAccountResource(
        ECONIA_ADDR,
        `${ECONIA_ADDR}::registry::Registry`
      );
      const registry = resource.data as Registry;
      const marketInfo = await aptosClient.getTableItem(
        registry.market_id_to_info.table.inner.handle,
        {
          key_type: "u64",
          value_type: TypeTag.fromTablistNode({
            key: "u64",
            value: `${ECONIA_ADDR}::registry::MarketInfo`,
          }).toString(),
          key: marketId,
        }
      );
      console.log({ marketInfo });
      return registry;
    } catch (e) {
      console.log(e);
      return null;
    }
  });
};
